{% extends "base.html" %}

{% block title %}ê³µê²© ì‹œë®¬ë ˆì´í„° - í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ë°©ì–´ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-bug"></i> ê³µê²© ì‹œë®¬ë ˆì´í„°
        </h1>
        <p class="lead">
            OWASP LLM01ì— ì •ì˜ëœ ë‹¤ì–‘í•œ í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì²´ê³„ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.
        </p>
    </div>
</div>

<div class="row mt-4">
    <!-- ê³µê²© ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> ê³µê²© ì¹´í…Œê³ ë¦¬
                </h5>
            </div>
            <div class="list-group list-group-flush" id="categoryList">
                {% for category, attacks in scenarios.items() %}
                <a href="#" class="list-group-item list-group-item-action category-item" data-category="{{ category }}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">{{ category }}</h6>
                        <span class="badge bg-danger rounded-pill">{{ attacks|length }}</span>
                    </div>
                    <small class="text-muted">{{ attacks|length }}ê°œì˜ ì‹œë‚˜ë¦¬ì˜¤</small>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ ë° ì‹¤í–‰ -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-card-list"></i> ê³µê²© ì‹œë‚˜ë¦¬ì˜¤
                </h5>
            </div>
            <div class="card-body">
                <div id="scenarioContent">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-arrow-left" style="font-size: 2rem;"></i>
                        <p class="mt-3">ì™¼ìª½ì—ì„œ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì‹¤í–‰ ê²°ê³¼ -->
        <div class="card mt-3" id="resultCard" style="display: none;">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-data"></i> ì‹¤í–‰ ê²°ê³¼
                </h5>
            </div>
            <div class="card-body">
                <div id="executionResult"></div>
            </div>
        </div>

        <!-- ì¼ê´„ í…ŒìŠ¤íŠ¸ -->
        <div class="card mt-3">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-lightning"></i> ì¼ê´„ í…ŒìŠ¤íŠ¸
                </h5>
            </div>
            <div class="card-body">
                <p>ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ê³µê²©ì„ í•œ ë²ˆì— í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
                <button class="btn btn-warning" id="batchTestBtn" disabled>
                    <i class="bi bi-play-fill"></i> ì¼ê´„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                </button>
                <div id="batchProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="mt-2 mb-0 text-center" id="batchStatus"></p>
                </div>
            </div>
        </div>

        <!-- í†µê³„ -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up"></i> í…ŒìŠ¤íŠ¸ í†µê³„
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-3">
                        <h4 id="statTotal">0</h4>
                        <small class="text-muted">ì´ í…ŒìŠ¤íŠ¸</small>
                    </div>
                    <div class="col-3">
                        <h4 id="statBlocked" class="text-success">0</h4>
                        <small class="text-muted">ì°¨ë‹¨</small>
                    </div>
                    <div class="col-3">
                        <h4 id="statPassed" class="text-danger">0</h4>
                        <small class="text-muted">í†µê³¼</small>
                    </div>
                    <div class="col-3">
                        <h4 id="statRate">0%</h4>
                        <small class="text-muted">ì°¨ë‹¨ìœ¨</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Jinja2 ë³€ìˆ˜ë¥¼ JavaScriptë¡œ ì•ˆì „í•˜ê²Œ ì „ë‹¬
    const scenariosData = JSON.parse('{{ scenarios | tojson | safe }}');
    let currentCategory = null;
    let testStats = {
        total: 0,
        blocked: 0,
        passed: 0
    };

    // ì¹´í…Œê³ ë¦¬ ì„ íƒ
    $('.category-item').on('click', function(e) {
        e.preventDefault();
        $('.category-item').removeClass('active');
        $(this).addClass('active');
        
        currentCategory = $(this).data('category');
        displayScenarios(currentCategory);
        $('#batchTestBtn').prop('disabled', false);
    });

    // ì‹œë‚˜ë¦¬ì˜¤ í‘œì‹œ
    function displayScenarios(category) {
        const categoryScenarios = scenariosData[category];
        let html = '<h5 class="mb-3">' + escapeHtml(category) + '</h5>';
        
        categoryScenarios.forEach(function(scenario, index) {
            html += '<div class="card mb-3">';
            html += '<div class="card-body">';
            html += '<h6 class="card-title">' + escapeHtml(scenario.name) + '</h6>';
            html += '<p class="card-text small text-muted">' + escapeHtml(scenario.description) + '</p>';
            html += '<pre class="bg-light p-2 rounded"><code>' + escapeHtml(scenario.prompt) + '</code></pre>';
            html += '<button class="btn btn-sm btn-primary test-scenario" data-index="' + index + '">';
            html += '<i class="bi bi-play"></i> í…ŒìŠ¤íŠ¸ ì‹¤í–‰';
            html += '</button>';
            html += '</div>';
            html += '</div>';
        });
        
        $('#scenarioContent').html(html);
        
        // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì´ë²¤íŠ¸
        $('.test-scenario').on('click', function() {
            const index = $(this).data('index');
            const scenario = categoryScenarios[index];
            executeTest(scenario);
        });
    }

    // ë‹¨ì¼ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    function executeTest(scenario) {
        $('#resultCard').show();
        $('#executionResult').html('<div class="spinner-border text-info" role="status"><span class="visually-hidden">Loading...</span></div>');
        
        $.ajax({
            url: '/api/comparison',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ message: scenario.prompt }),
            success: function(response) {
                if (response.success) {
                    displayTestResult(scenario, response);
                    updateStats(response.protected.is_blocked);
                }
            },
            error: function() {
                $('#executionResult').html('<div class="alert alert-danger">í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>');
            }
        });
    }

    // í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ
    function displayTestResult(scenario, response) {
        const isBlocked = response.protected.is_blocked;
        const detection = response.protected.detection || {};
        
        let html = '<div class="alert ' + (isBlocked ? 'alert-success' : 'alert-danger') + '">';
        html += '<h6>' + (isBlocked ? 'âœ… ê³µê²© ì°¨ë‹¨ ì„±ê³µ' : 'ğŸš¨ ê³µê²© í†µê³¼ (ì·¨ì•½ì  ë°œê²¬)') + '</h6>';
        html += '</div>';
        
        html += '<h6>ê³µê²© ì •ë³´</h6>';
        html += '<ul>';
        html += '<li><strong>ê³µê²©ëª…:</strong> ' + escapeHtml(scenario.name) + '</li>';
        html += '<li><strong>ì„¤ëª…:</strong> ' + escapeHtml(scenario.description) + '</li>';
        html += '<li><strong>ìœ„í—˜ë„:</strong> ' + ((detection.risk_score || 0) * 100).toFixed(1) + '%</li>';
        html += '</ul>';
        
        html += '<h6 class="mt-3">ì·¨ì•½í•œ ë²„ì „ ì‘ë‹µ</h6>';
        html += '<div class="alert alert-danger">';
        html += escapeHtml(response.vulnerable.response);
        html += '</div>';
        
        html += '<h6>ë°©ì–´ ë²„ì „ ì‘ë‹µ</h6>';
        html += '<div class="alert ' + (isBlocked ? 'alert-success' : 'alert-warning') + '">';
        html += escapeHtml(response.protected.response);
        html += '</div>';
        
        $('#executionResult').html(html);
    }

    // ì¼ê´„ í…ŒìŠ¤íŠ¸
    $('#batchTestBtn').on('click', function() {
        if (!currentCategory) return;
        
        const categoryScenarios = scenariosData[currentCategory];
        let completed = 0;
        let blocked = 0;
        
        $('#batchProgress').show();
        $(this).prop('disabled', true);
        
        function testNext(index) {
            if (index >= categoryScenarios.length) {
                // ì™„ë£Œ
                const rate = (blocked / categoryScenarios.length * 100).toFixed(1);
                $('#batchStatus').html('<strong>ì™„ë£Œ:</strong> ' + categoryScenarios.length + 'ê°œ ì¤‘ ' + blocked + 'ê°œ ì°¨ë‹¨ (' + rate + '%)');
                $('#batchTestBtn').prop('disabled', false);
                return;
            }
            
            const scenario = categoryScenarios[index];
            const progress = ((index + 1) / categoryScenarios.length * 100).toFixed(0);
            
            $('.progress-bar').css('width', progress + '%');
            $('#batchStatus').text('í…ŒìŠ¤íŠ¸ ì¤‘... (' + (index + 1) + '/' + categoryScenarios.length + ')');
            
            $.ajax({
                url: '/api/comparison',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ message: scenario.prompt }),
                success: function(response) {
                    if (response.success && response.protected.is_blocked) {
                        blocked++;
                    }
                    updateStats(response.protected.is_blocked);
                },
                complete: function() {
                    setTimeout(function() { testNext(index + 1); }, 500);
                }
            });
        }
        
        testNext(0);
    });

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats(isBlocked) {
        testStats.total++;
        if (isBlocked) {
            testStats.blocked++;
        } else {
            testStats.passed++;
        }
        
        const rate = testStats.total > 0 ? 
            (testStats.blocked / testStats.total * 100).toFixed(1) : 0;
        
        $('#statTotal').text(testStats.total);
        $('#statBlocked').text(testStats.blocked);
        $('#statPassed').text(testStats.passed);
        $('#statRate').text(rate + '%');
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
    }
});
</script>
{% endblock %}