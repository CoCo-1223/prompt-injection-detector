{% extends "base.html" %}

{% block title %}ë¹„êµ ë¶„ì„ - í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ ë°©ì–´ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-arrow-left-right"></i> Before vs After ë¹„êµ ë¶„ì„
        </h1>
        <p class="lead">
            ë™ì¼í•œ ê³µê²©ì„ ì·¨ì•½í•œ ë²„ì „ê³¼ ë°©ì–´ ì ìš© ë²„ì „ì— ë™ì‹œì— ì‹œë„í•˜ì—¬ ë°©ì–´ íš¨ê³¼ë¥¼ ì§ì ‘ ë¹„êµí•˜ì„¸ìš”.
        </p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-chat-dots"></i> í…ŒìŠ¤íŠ¸ ì…ë ¥
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="testInput" class="form-label">ê³µê²© í”„ë¡¬í”„íŠ¸ ì…ë ¥:</label>
                    <textarea class="form-control" id="testInput" rows="3" placeholder="í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ì„¸ìš”..."></textarea>
                </div>
                <button class="btn btn-primary" id="compareBtn">
                    <i class="bi bi-arrow-left-right"></i> ë¹„êµ ì‹¤í–‰
                </button>
                <button class="btn btn-secondary" id="clearBtn">
                    <i class="bi bi-trash"></i> ì´ˆê¸°í™”
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i> ì‚¬ì „ ì •ì˜ëœ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for attack in attacks[:6] %}
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-outline-danger w-100 text-start scenario-btn" data-prompt="{{ attack.prompt }}">
                            <strong>{{ attack.name }}</strong><br>
                            <small class="text-muted">{{ attack.description }}</small>
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ë¹„êµ ê²°ê³¼ -->
<div class="row mt-4" id="resultSection" style="display: none;">
    <div class="col-md-6">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i> BEFORE: ì·¨ì•½í•œ ë²„ì „
                </h5>
            </div>
            <div class="card-body">
                <div id="vulnerableResult">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    <i class="bi bi-shield-x"></i> ë°©ì–´ ë ˆì´ì–´: ì—†ìŒ
                </small>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-shield-check"></i> AFTER: ë°©ì–´ ì ìš© ë²„ì „
                </h5>
            </div>
            <div class="card-body">
                <div id="protectedResult">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    <i class="bi bi-shield-check"></i> ë°©ì–´ ë ˆì´ì–´: Layer 1 + 2 + 3
                </small>
            </div>
        </div>
    </div>
</div>

<!-- ë¶„ì„ ê²°ê³¼ -->
<div class="row mt-4" id="analysisSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up"></i> íƒì§€ ë¶„ì„
                </h5>
            </div>
            <div class="card-body">
                <div id="analysisResult"></div>
            </div>
        </div>
    </div>
</div>

<!-- í…ŒìŠ¤íŠ¸ íˆìŠ¤í† ë¦¬ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> í…ŒìŠ¤íŠ¸ íˆìŠ¤í† ë¦¬
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="historyTable">
                        <thead>
                            <tr>
                                <th>ì‹œê°„</th>
                                <th>ì…ë ¥</th>
                                <th>ì·¨ì•½ ë²„ì „</th>
                                <th>ë°©ì–´ ë²„ì „</th>
                                <th>ê²°ê³¼</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    í…ŒìŠ¤íŠ¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const testInput = $('#testInput');
    const compareBtn = $('#compareBtn');
    const clearBtn = $('#clearBtn');
    const resultSection = $('#resultSection');
    const analysisSection = $('#analysisSection');
    const vulnerableResult = $('#vulnerableResult');
    const protectedResult = $('#protectedResult');
    const analysisResult = $('#analysisResult');
    const historyBody = $('#historyBody');

    let testHistory = [];

    // ì‹œë‚˜ë¦¬ì˜¤ ë²„íŠ¼ í´ë¦­
    $('.scenario-btn').on('click', function() {
        const prompt = $(this).data('prompt');
        testInput.val(prompt);
    });

    // ë¹„êµ ì‹¤í–‰
    compareBtn.on('click', function() {
        const prompt = testInput.val().trim();
        if (!prompt) {
            alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
        resultSection.show();
        analysisSection.show();
        
        // ë¡œë”© ìƒíƒœ
        vulnerableResult.html('<div class="spinner-border text-danger" role="status"><span class="visually-hidden">Loading...</span></div>');
        protectedResult.html('<div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div>');
        analysisResult.html('<div class="spinner-border text-info" role="status"><span class="visually-hidden">Loading...</span></div>');
        
        compareBtn.prop('disabled', true);

        // API í˜¸ì¶œ
        $.ajax({
            url: '/api/comparison',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ message: prompt }),
            success: function(response) {
                if (response.success) {
                    displayResults(prompt, response.vulnerable, response.protected);
                } else {
                    alert('ì˜¤ë¥˜: ' + response.error);
                }
            },
            error: function() {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            },
            complete: function() {
                compareBtn.prop('disabled', false);
            }
        });
    });

    // ê²°ê³¼ í‘œì‹œ
    function displayResults(prompt, vulnerable, protected) {
        // ì·¨ì•½í•œ ë²„ì „ ê²°ê³¼
        if (vulnerable.success) {
            const vulnHtml = `
                <div class="alert alert-danger">
                    <strong>ğŸš¨ ê³µê²© ì„±ê³µ</strong>
                </div>
                <div class="response-text">
                    ${escapeHtml(vulnerable.response)}
                </div>
            `;
            vulnerableResult.html(vulnHtml);
        } else {
            vulnerableResult.html(`<div class="alert alert-danger">ì˜¤ë¥˜: ${vulnerable.error}</div>`);
        }

        // ë°©ì–´ ë²„ì „ ê²°ê³¼
        if (protected.success) {
            const isBlocked = protected.is_blocked;
            const protHtml = `
                <div class="alert ${isBlocked ? 'alert-success' : 'alert-warning'}">
                    <strong>${isBlocked ? 'âœ… ê³µê²© ì°¨ë‹¨' : 'âš ï¸ ì‘ë‹µ ìƒì„±'}</strong>
                </div>
                <div class="response-text">
                    ${escapeHtml(protected.response)}
                </div>
            `;
            protectedResult.html(protHtml);
        } else {
            protectedResult.html(`<div class="alert alert-danger">ì˜¤ë¥˜: ${protected.error}</div>`);
        }

        // ë¶„ì„ ê²°ê³¼
        displayAnalysis(prompt, vulnerable, protected);
        
        // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
        addToHistory(prompt, vulnerable, protected);
    }

    // ë¶„ì„ í‘œì‹œ
    function displayAnalysis(prompt, vulnerable, protected) {
        const detection = protected.detection || {};
        const isMalicious = detection.is_malicious;
        const riskScore = (detection.risk_score * 100).toFixed(1);
        
        let analysisHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6>íƒì§€ ê²°ê³¼</h6>
                    <ul class="list-unstyled">
                        <li><strong>ì•…ì„± ì—¬ë¶€:</strong> 
                            <span class="badge ${isMalicious ? 'bg-danger' : 'bg-success'}">
                                ${isMalicious ? 'ì•…ì„±' : 'ì •ìƒ'}
                            </span>
                        </li>
                        <li><strong>ìœ„í—˜ë„:</strong> ${riskScore}%</li>
                        <li><strong>íƒì§€ ë°©ë²•:</strong> ${detection.detection_method || 'N/A'}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>ë°©ì–´ íš¨ê³¼</h6>
                    <ul class="list-unstyled">
                        <li><strong>ì·¨ì•½ ë²„ì „:</strong> <span class="badge bg-danger">ì •ë³´ ìœ ì¶œ ê°€ëŠ¥</span></li>
                        <li><strong>ë°©ì–´ ë²„ì „:</strong> <span class="badge bg-success">ê³µê²© ì°¨ë‹¨</span></li>
                        <li><strong>ì°¨ë‹¨ ì—¬ë¶€:</strong> ${protected.is_blocked ? 'âœ… ì°¨ë‹¨ë¨' : 'âŒ í†µê³¼'}</li>
                    </ul>
                </div>
            </div>
        `;
        
        if (detection.detected_patterns && detection.detected_patterns.length > 0) {
            analysisHtml += `
                <hr>
                <h6>íƒì§€ëœ íŒ¨í„´</h6>
                <ul>
            `;
            detection.detected_patterns.forEach(pattern => {
                analysisHtml += `<li>${JSON.stringify(pattern)}</li>`;
            });
            analysisHtml += `</ul>`;
        }
        
        analysisResult.html(analysisHtml);
    }

    // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
    function addToHistory(prompt, vulnerable, protected) {
        const timestamp = new Date().toLocaleTimeString('ko-KR');
        const vulnStatus = vulnerable.success ? 'ğŸ”´ ìœ ì¶œ' : 'âŒ ì˜¤ë¥˜';
        const protStatus = protected.is_blocked ? 'ğŸ›¡ï¸ ì°¨ë‹¨' : 'âš ï¸ í†µê³¼';
        const result = protected.is_blocked ? '<span class="badge bg-success">ë°©ì–´ ì„±ê³µ</span>' : '<span class="badge bg-warning">ì¶”ê°€ ê²€í†  í•„ìš”</span>';
        
        const row = `
            <tr>
                <td>${timestamp}</td>
                <td><small>${escapeHtml(prompt.substring(0, 50))}${prompt.length > 50 ? '...' : ''}</small></td>
                <td>${vulnStatus}</td>
                <td>${protStatus}</td>
                <td>${result}</td>
            </tr>
        `;
        
        if (historyBody.find('td[colspan]').length > 0) {
            historyBody.html('');
        }
        
        historyBody.prepend(row);
    }

    // ì´ˆê¸°í™”
    clearBtn.on('click', function() {
        testInput.val('');
        resultSection.hide();
        analysisSection.hide();
    });

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
});
</script>
{% endblock %}